<style>
    :root {
        --primary: #3bf689;
        --secondary: #e0ec3a;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --info: #0ea5e9;
    }
    
    .app-detail-card {
        transition: all 0.2s ease;
        border: 1px solid #e5e7eb;
    }
    
    .app-detail-card:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    .status-badge {
        font-size: 0.7rem;
        padding: 0.15rem 0.5rem;
    }
    
    .status-pending { background-color: #fef3c7; color: #92400e; }
    .status-approved { background-color: #d1fae5; color: #065f46; }
    .status-rejected { background-color: #fee2e2; color: #991b1b; }
    
    .detail-section {
        border-bottom: 1px solid #f3f4f6;
        padding-bottom: 1rem;
        margin-bottom: 1rem;
    }
    
    .detail-section:last-child {
        border-bottom: none;
        padding-bottom: 0;
        margin-bottom: 0;
    }
</style>

<body class="bg-gray-50">
    <!-- Navbar -->
    <%-include('./partials/topnav') %>

    <!-- Sidebar -->
    <%-include('./partials/sidenav') %>

    <!-- Main Content -->
    <div class="container mx-auto px-2 py-4 mt-4">
        <div class="flex flex-col lg:flex-row gap-4">
            <!-- Static Sidebar -->
            <div class="hidden lg:block lg:w-1/4">
                <%-include('./partials/staticsidebar') %>
            </div>

            <!-- Main Content Area -->
            <div class="lg:w-3/4">
                <!-- Header -->
                <div class="mb-6">
                    <div class="flex justify-between items-center">
                        <div>
                            <a href="/admin/affiliate/applications" 
                               class="inline-flex items-center gap-2 px-3 py-1.5 bg-white border border-gray-300 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-50 transition-colors mb-2">
                                <i class="fas fa-arrow-left text-xs"></i>
                                Back to Applications
                            </a>
                            <h1 class="text-xl font-semibold text-gray-900">Application Details</h1>
                            <p class="text-sm text-gray-500 mt-1">Review affiliate application</p>
                        </div>
                    </div>
                </div>

                <%- include('../partials/messages') %>

                <!-- Application Details -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <!-- Left Column - Status & Actions -->
                    <div class="space-y-4">
                        <!-- Status Card -->
                        <div class="app-detail-card bg-white rounded-lg p-4">
                            <div class="detail-section">
                                <h3 class="text-sm font-semibold text-gray-900 mb-3">Application Overview</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-xs text-gray-500">Application Title</label>
                                        <p class="text-sm font-medium text-gray-900"><%= application.title || 'Untitled' %></p>
                                    </div>
                                    
                                    <div>
                                        <label class="text-xs text-gray-500">Status</label>
                                        <div class="mt-1">
                                            <% 
                                            const statusClass = application.status === 'pending' ? 'status-pending' :
                                                              application.status === 'approved' ? 'status-approved' :
                                                              application.status === 'rejected' ? 'status-rejected' : 'status-pending';
                                            %>
                                            <span class="inline-flex items-center status-badge <%= statusClass %> rounded-full">
                                                <span class="w-1.5 h-1.5 rounded-full mr-1.5 
                                                    <%= application.status === 'pending' ? 'bg-amber-500' :
                                                       application.status === 'approved' ? 'bg-green-500' :
                                                       application.status === 'rejected' ? 'bg-red-500' : 'bg-gray-500' %>"></span>
                                                <%= application.status.charAt(0).toUpperCase() + application.status.slice(1) %>
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="text-xs text-gray-500">Vetted By</label>
                                        <p class="text-sm text-gray-900"><%= application.reviewed_by || 'Not reviewed yet' %></p>
                                    </div>
                                    
                                    <div>
                                        <label class="text-xs text-gray-500">Submitted On</label>
                                        <p class="text-sm text-gray-900">
                                            <%= application.created_at.toLocaleDateString('en-US', { 
                                                month: 'short',
                                                day: 'numeric',
                                                year: 'numeric'
                                            }) %>
                                        </p>
                                        <p class="text-xs text-gray-500">
                                            <%= application.created_at.toLocaleTimeString('en-US', { 
                                                hour: 'numeric',
                                                minute: '2-digit',
                                                hour12: true
                                            }) %>
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Approval Toggle -->
                            <div class="detail-section">
                                <h3 class="text-sm font-semibold text-gray-900 mb-3">Status Control</h3>
                                <form action="/admin/affiliate/applications/<%= application.id %>/<%= application.status === 'approved' ? 'pending' : 'approved' %>" 
                                      method="post">
                                    <input type="hidden" name="_method" value="PUT">
                                    <input type="hidden" name="userId" value="<%= application.user_id %>">
                                    
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <label class="text-sm font-medium text-gray-700">Approval Status</label>
                                            <p class="text-xs text-gray-500">Toggle to approve/reject</p>
                                        </div>
                                        <label class="inline-flex items-center cursor-pointer">
                                            <input type="checkbox" 
                                                   name="approval" 
                                                   class="sr-only peer"
                                                   onchange="this.form.submit()"
                                                   <%= application.status === 'approved' ? 'checked' : '' %>
                                                   <%= application.status === 'banned' ? 'disabled' : '' %>>
                                            <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                                        </label>
                                    </div>
                                </form>
                            </div>
                            
                            <!-- Quick Actions -->
                            <div>
                                <h3 class="text-sm font-semibold text-gray-900 mb-3">Quick Actions</h3>
                                <div class="space-y-2">
                                    <a href="mailto:<%= application.email %>" 
                                       class="flex items-center gap-2 px-3 py-2 text-blue-600 hover:bg-blue-50 rounded-lg text-sm transition-colors">
                                        <i class="fas fa-envelope text-xs"></i>
                                        Email Applicant
                                    </a>
                                    <% if (application.status !== 'approved') { %>
                                        <form action="/admin/affiliate/applications/<%= application.id %>/reject" 
                                              method="post"
                                              onsubmit="return confirm('Reject this application?')">
                                            <input type="hidden" name="_method" value="PUT">
                                            <button type="submit" 
                                                    class="w-full flex items-center gap-2 px-3 py-2 text-red-600 hover:bg-red-50 rounded-lg text-sm transition-colors">
                                                <i class="fas fa-times text-xs"></i>
                                                Reject Application
                                            </button>
                                        </form>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column - Applicant Details -->
                    <div class="lg:col-span-2">
                        <div class="app-detail-card bg-white rounded-lg p-4">
                            <!-- Applicant Information -->
                            <div class="detail-section">
                                <h3 class="text-sm font-semibold text-gray-900 mb-4">Applicant Information</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-xs text-gray-500">Full Name</label>
                                        <p class="text-sm text-gray-900 font-medium"><%= application.full_name || 'Not provided' %></p>
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500">Email Address</label>
                                        <p class="text-sm text-gray-900 font-medium"><%= application.email || 'Not provided' %></p>
                                    </div>
                                </div>
                            </div>

                            <!-- Application Text -->
                            <div class="detail-section">
                                <h3 class="text-sm font-semibold text-gray-900 mb-3">Why They Want to Join</h3>
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <p class="text-sm text-gray-700 whitespace-pre-line">
                                        <%= application.application_text || 'No description provided.' %>
                                    </p>
                                </div>
                            </div>

                            <!-- How They Knew -->
                            <% if (application.ref_source) { %>
                                <div class="detail-section">
                                    <h3 class="text-sm font-semibold text-gray-900 mb-3">How They Knew About Us</h3>
                                    <div class="bg-blue-50 rounded-lg p-3">
                                        <p class="text-sm text-gray-700"><%= application.ref_source %></p>
                                    </div>
                                </div>
                            <% } %>

                            <!-- Prior Experience -->
                            <% if (application.experience) { %>
                                <div class="detail-section">
                                    <h3 class="text-sm font-semibold text-gray-900 mb-3">Prior Experience</h3>
                                    <div class="bg-green-50 rounded-lg p-3">
                                        <p class="text-sm text-gray-700 whitespace-pre-line">
                                            <%= application.experience %>
                                        </p>
                                    </div>
                                </div>
                            <% } %>

                            <!-- Additional Information -->
                            <div class="detail-section">
                                <h3 class="text-sm font-semibold text-gray-900 mb-3">Application Details</h3>
                                <div class="space-y-2 text-sm">
                                    <div class="flex items-center justify-between">
                                        <span class="text-gray-500">Application ID:</span>
                                        <span class="font-medium text-gray-900"><%= application.id %></span>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-gray-500">User ID:</span>
                                        <span class="font-medium text-gray-900"><%= application.user_id %></span>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-gray-500">Submitted:</span>
                                        <span class="font-medium text-gray-900">
                                            <%= application.created_at.toLocaleString('en-US', { 
                                                month: 'short',
                                                day: 'numeric',
                                                year: 'numeric',
                                                hour: 'numeric',
                                                minute: '2-digit'
                                            }) %>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Notes & Comments -->
                        <div class="mt-4 app-detail-card bg-white rounded-lg p-4">
                            <h3 class="text-sm font-semibold text-gray-900 mb-3">Review Notes</h3>
                            <form action="/admin/affiliate/applications/<%= application.id %>/notes" method="post">
                                <div class="mb-3">
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Add Note</label>
                                    <textarea name="notes" 
                                              rows="3"
                                              class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                              placeholder="Add review notes or comments..."></textarea>
                                </div>
                                <div class="flex justify-end">
                                    <button type="submit" 
                                            class="inline-flex items-center gap-1 px-4 py-2 bg-blue-500 text-white text-sm font-medium rounded-lg hover:bg-blue-600 transition-colors">
                                        <i class="fas fa-save text-xs"></i>
                                        Save Note
                                    </button>
                                </div>
                            </form>
                            
                            <!-- Existing Notes -->
                            <% if (application.notes && application.notes.length > 0) { %>
                                <div class="mt-4 pt-4 border-t border-gray-200">
                                    <h4 class="text-xs font-medium text-gray-700 mb-2">Previous Notes</h4>
                                    <div class="space-y-3">
                                        <% application.notes.forEach(note => { %>
                                            <div class="bg-gray-50 rounded-lg p-3">
                                                <div class="flex justify-between items-start mb-2">
                                                    <span class="text-xs font-medium text-gray-900"><%= note.author %></span>
                                                    <span class="text-xs text-gray-500">
                                                        <%= new Date(note.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) %>
                                                    </span>
                                                </div>
                                                <p class="text-sm text-gray-600"><%= note.content %></p>
                                            </div>
                                        <% }) %>
                                    </div>
                                </div>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize any interactive elements
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Application details page loaded');
            
            // Copy email to clipboard
            const copyEmailBtn = document.getElementById('copyEmailBtn');
            if (copyEmailBtn) {
                copyEmailBtn.addEventListener('click', function() {
                    const email = '<%= application.email %>';
                    navigator.clipboard.writeText(email).then(function() {
                        alert('Email copied to clipboard!');
                    });
                });
            }
            
            // Status change confirmation
            const statusToggle = document.querySelector('input[name="approval"]');
            if (statusToggle) {
                statusToggle.addEventListener('change', function(e) {
                    const currentStatus = '<%= application.status %>';
                    const newStatus = this.checked ? 'approved' : 'pending';
                    
                    if (currentStatus !== newStatus) {
                        const confirmed = confirm(`Change application status to ${newStatus}?`);
                        if (!confirmed) {
                            e.preventDefault();
                            this.checked = !this.checked;
                        }
                    }
                });
            }
        });
        
        // Quick status change functions
        function approveApplication() {
            if (confirm('Approve this application?')) {
                window.location.href = `/admin/affiliate/applications/<%= application.id %>/approve`;
            }
        }
        
        function rejectApplication() {
            if (confirm('Reject this application?')) {
                window.location.href = `/admin/affiliate/applications/<%= application.id %>/reject`;
            }
        }
    </script>
</body>
<style>
    :root {
        --primary: #3bf689;
        --secondary: #e0ec3a;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --info: #0ea5e9;
    }
    
    .session-card {
        transition: all 0.2s ease;
        border: 1px solid #e5e7eb;
    }
    
    .session-card:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    
    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 4px;
    }
    
    .status-true { background-color: #10b981; }
    .status-false { background-color: #6b7280; }
    
    .time-badge {
        font-size: 0.7rem;
        padding: 0.2rem 0.5rem;
    }
</style>

<body class="bg-gray-50">
    <!-- Navbar -->
    <%-include('./partials/topnav') %>

    <!-- Sidebar -->
    <%-include('./partials/sidenav') %>

    <!-- Main Content -->
    <div class="container mx-auto px-2 py-4 mt-4">
        <div class="flex flex-col lg:flex-row gap-4">
            <!-- Static Sidebar -->
            <div class="hidden lg:block lg:w-1/4">
                <%-include('./partials/staticsidebar') %>
            </div>

            <!-- Main Content Area -->
            <div class="lg:w-3/4">
                <!-- Header -->
                <div class="mb-6">
                    <div class="flex justify-between items-center">
                        <div>
                            <a href="/admin/courses" 
                               class="inline-flex items-center gap-2 px-3 py-1.5 bg-white border border-gray-300 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-50 transition-colors mb-2">
                                <i class="fas fa-arrow-left text-xs"></i>
                                All Programs
                            </a>
                            <h1 class="text-xl font-semibold text-gray-900">Sessions</h1>
                            <p class="text-sm text-gray-500 mt-1">Manage class sessions for this program</p>
                        </div>
                        <button onclick="openCreateSessionModal()" 
                                class="inline-flex items-center gap-2 px-3 py-2 bg-blue-500 text-white font-medium rounded-lg hover:bg-blue-600 transition-colors text-sm">
                            <i class="fas fa-plus text-xs"></i>
                            New Session
                        </button>
                    </div>
                </div>

                <%- include('../partials/messages') %>

                <!-- Sessions Grid -->
                <div class="mb-6">
                    <% if (sessions && sessions.length > 0) { %>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                            <% 
                            sessions.forEach(function(data, index) { 
                                const scheduled = new Date(data.scheduled_at);
                                const now = new Date();
                                const isPast = scheduled < now;
                                const isToday = scheduled.toDateString() === now.toDateString();
                                const isFuture = scheduled > now;
                                
                                // Determine status based on boolean and timing
                                let statusText = 'Pending';
                                let statusClass = 'status-false';
                                
                                if (data.status === true) {
                                    statusText = 'Active';
                                    statusClass = 'status-true';
                                } else if (isPast) {
                                    statusText = 'Ended';
                                } else if (isToday) {
                                    statusText = 'Today';
                                } else if (isFuture) {
                                    statusText = 'Upcoming';
                                }
                            %>
                                <div class="session-card bg-white rounded-lg p-4">
                                    <!-- Session Header -->
                                    <div class="flex items-start justify-between mb-3">
                                        <div>
                                            <div class="flex items-center gap-2 mb-2">
                                                <span class="status-dot <%= statusClass %>"></span>
                                                <span class="text-xs font-medium 
                                                    <%= data.status === true ? 'text-green-600' : 
                                                       isPast ? 'text-gray-600' : 
                                                       isToday ? 'text-blue-600' : 'text-amber-600' %>">
                                                    <%= statusText %>
                                                </span>
                                                <% if (isToday) { %>
                                                    <span class="time-badge bg-blue-100 text-blue-700 rounded">Today</span>
                                                <% } %>
                                            </div>
                                            <h3 class="text-sm font-semibold text-gray-900 line-clamp-2 mb-2" 
                                                title="<%= data.title %>">
                                                <%= data.title %>
                                            </h3>
                                        </div>
                                        <span class="text-xs text-gray-400">#<%= index + 1 %></span>
                                    </div>
                                    
                                    <!-- Session Info -->
                                    <div class="mb-4 space-y-2">
                                        <div class="flex items-center gap-2 text-xs text-gray-500">
                                            <i class="far fa-calendar text-gray-400"></i>
                                            <span>
                                                <%= scheduled.toLocaleDateString('en-US', { 
                                                    weekday: 'short',
                                                    month: 'short', 
                                                    day: 'numeric' 
                                                }) %>
                                            </span>
                                        </div>
                                        <div class="flex items-center gap-2 text-xs text-gray-500">
                                            <i class="far fa-clock text-gray-400"></i>
                                            <span>
                                                <%= scheduled.toLocaleTimeString('en-US', { 
                                                    hour: 'numeric', 
                                                    minute: '2-digit',
                                                    hour12: true 
                                                }) %>
                                            </span>
                                        </div>
                                        <% if (data.description) { %>
                                            <p class="text-xs text-gray-600 line-clamp-2 mt-2">
                                                <%= data.description %>
                                            </p>
                                        <% } %>
                                    </div>
                                    
                                    <!-- Session Actions -->
                                    <div class="flex gap-2">
                                        <a href="/admin/class/<%= data.id %>/<%= courseId %>" 
                                           class="flex-1 inline-flex items-center justify-center gap-1 px-2 py-1.5 bg-gray-100 text-gray-700 text-xs font-medium rounded hover:bg-gray-200 transition-colors">
                                            <i class="fas fa-eye text-xs"></i>
                                            View
                                        </a>
                                        <button onclick="openDeleteModal('<%= data.id %>', '<%= data.title %>')" 
                                                class="inline-flex items-center justify-center w-8 h-8 bg-red-50 text-red-600 text-xs font-medium rounded hover:bg-red-100 transition-colors">
                                            <i class="fas fa-trash text-xs"></i>
                                        </button>
                                    </div>
                                </div>
                            <% }) %>
                        </div>
                    <% } else { %>
                        <!-- Empty State -->
                        <div class="bg-white rounded-lg border border-gray-200 p-8 text-center">
                            <div class="mb-4">
                                <i class="fas fa-calendar-times text-gray-300 text-3xl"></i>
                            </div>
                            <h3 class="text-sm font-medium text-gray-700 mb-2">No sessions created</h3>
                            <p class="text-xs text-gray-500 mb-4 max-w-md mx-auto">
                                This program doesn't have any scheduled sessions yet. Create your first session to get started.
                            </p>
                            <button onclick="openCreateSessionModal()" 
                                    class="inline-flex items-center gap-1 px-3 py-2 bg-blue-500 text-white text-sm font-medium rounded-lg hover:bg-blue-600 transition-colors">
                                <i class="fas fa-plus text-xs"></i>
                                Create First Session
                            </button>
                        </div>
                    <% } %>
                </div>

                <!-- Stats Summary -->
                <% if (sessions && sessions.length > 0) { %>
                    <%
                    const activeCount = sessions.filter(s => s.status === true).length;
                    const now = new Date();
                    const pastCount = sessions.filter(s => new Date(s.scheduled_at) < now).length;
                    const todayCount = sessions.filter(s => {
                        const scheduled = new Date(s.scheduled_at);
                        return scheduled.toDateString() === now.toDateString();
                    }).length;
                    const futureCount = sessions.filter(s => new Date(s.scheduled_at) > now).length;
                    %>
                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                        <div class="flex items-center justify-between">
                            <div class="text-sm text-gray-600">
                                <span class="font-medium text-gray-900"><%= sessions.length %></span> session(s) total
                            </div>
                            <div class="flex flex-wrap gap-3 text-xs text-gray-500">
                                <div class="flex items-center gap-1">
                                    <div class="w-2 h-2 rounded-full bg-green-500"></div>
                                    <span class="font-medium text-green-600"><%= activeCount %></span> active
                                </div>
                                <div class="flex items-center gap-1">
                                    <div class="w-2 h-2 rounded-full bg-blue-500"></div>
                                    <span class="font-medium text-blue-600"><%= todayCount %></span> today
                                </div>
                                <div class="flex items-center gap-1">
                                    <div class="w-2 h-2 rounded-full bg-amber-500"></div>
                                    <span class="font-medium text-amber-600"><%= futureCount %></span> upcoming
                                </div>
                                <div class="flex items-center gap-1">
                                    <div class="w-2 h-2 rounded-full bg-gray-500"></div>
                                    <span class="font-medium text-gray-600"><%= pastCount %></span> past
                                </div>
                            </div>
                        </div>
                    </div>
                <% } %>
            </div>
        </div>
    </div>

    <!-- Create Session Modal -->
    <div id="createSessionModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-lg max-w-md w-full">
                <div class="p-5">
                    <div class="flex justify-between items-center mb-5">
                        <h3 class="text-lg font-semibold text-gray-900">Create Session</h3>
                        <button onclick="closeCreateSessionModal()" class="text-gray-400 hover:text-gray-500">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <form method="post" action="/admin/class">
                        <div class="space-y-4">
                            <!-- Title -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                                <input type="text" 
                                       name="title" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="Session title"
                                       required />
                            </div>

                            <!-- Description -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                <textarea name="description" 
                                          rows="2"
                                          class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                          placeholder="Brief description..."
                                          required></textarea>
                            </div>

                            <!-- Date & Time -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Date & Time</label>
                                <input type="datetime-local" 
                                       name="scheduled_at" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                       required />
                            </div>

                            <!-- Meeting Link -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Meeting Link</label>
                                <input type="url" 
                                       name="meet_link" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="https://meet.example.com/room"
                                       required />
                            </div>

                            <!-- Status (optional) -->
                            <div>
                                <label class="flex items-center gap-2 text-sm text-gray-700">
                                    <input type="checkbox" 
                                           name="status" 
                                           class="rounded border-gray-300 text-blue-500 focus:ring-blue-500"
                                           value="true" />
                                    <span>Start session as active</span>
                                </label>
                                <p class="text-xs text-gray-500 mt-1">Leave unchecked to create as pending</p>
                            </div>

                            <!-- Hidden Course ID -->
                            <input type="hidden" name="courseId" value="<%= courseId %>" />
                        </div>

                        <!-- Form Actions -->
                        <div class="flex justify-end gap-2 mt-6 pt-5 border-t border-gray-200">
                            <button type="button" 
                                    onclick="closeCreateSessionModal()"
                                    class="px-4 py-2 border border-gray-300 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-50">
                                Cancel
                            </button>
                            <button type="submit" 
                                    class="px-4 py-2 bg-blue-500 text-white text-sm font-medium rounded-lg hover:bg-blue-600 flex items-center gap-1">
                                <i class="fas fa-plus text-xs"></i>
                                Create Session
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-lg max-w-sm w-full">
                <div class="p-5">
                    <div class="flex justify-between items-center mb-5">
                        <h3 class="text-lg font-semibold text-gray-900">Delete Session</h3>
                        <button onclick="closeDeleteModal()" class="text-gray-400 hover:text-gray-500">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="mb-6">
                        <div class="flex items-center justify-center w-12 h-12 rounded-full bg-red-100 mx-auto mb-4">
                            <i class="fas fa-exclamation-triangle text-red-500"></i>
                        </div>
                        <p class="text-sm text-gray-600 text-center">
                            Are you sure you want to delete <span id="deleteSessionTitle" class="font-semibold"></span>?
                        </p>
                        <p class="text-xs text-gray-500 text-center mt-2">This action cannot be undone.</p>
                    </div>
                    
                    <form id="deleteForm" method="post" action="">
                        <input type="hidden" name="_method" value="DELETE">
                        <input type="hidden" name="courseId" value="<%= courseId %>">
                        
                        <div class="flex justify-end gap-2">
                            <button type="button" 
                                    onclick="closeDeleteModal()"
                                    class="px-4 py-2 border border-gray-300 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-50">
                                Cancel
                            </button>
                            <button type="submit" 
                                    class="px-4 py-2 bg-red-500 text-white text-sm font-medium rounded-lg hover:bg-red-600 flex items-center gap-1">
                                <i class="fas fa-trash text-xs"></i>
                                Delete
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Modal functions
        let currentDeleteId = null;
        
        function openCreateSessionModal() {
            // Set default time to next hour
            const now = new Date();
            now.setHours(now.getHours() + 1);
            now.setMinutes(0);
            now.setSeconds(0);
            
            const formattedDateTime = now.toISOString().slice(0, 16);
            const datetimeInput = document.querySelector('input[name="scheduled_at"]');
            if (datetimeInput) {
                datetimeInput.value = formattedDateTime;
            }
            
            document.getElementById('createSessionModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        
        function closeCreateSessionModal() {
            document.getElementById('createSessionModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
        
        function openDeleteModal(sessionId, sessionTitle) {
            currentDeleteId = sessionId;
            document.getElementById('deleteSessionTitle').textContent = `"${sessionTitle}"`;
            document.getElementById('deleteForm').action = `/admin/class/${sessionId}`;
            document.getElementById('deleteModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        
        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
            currentDeleteId = null;
        }
        
        // Close modals on outside click
        document.getElementById('createSessionModal').addEventListener('click', function(e) {
            if (e.target === this) closeCreateSessionModal();
        });
        
        document.getElementById('deleteModal').addEventListener('click', function(e) {
            if (e.target === this) closeDeleteModal();
        });
        
        // Escape key to close modals
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeCreateSessionModal();
                closeDeleteModal();
            }
        });
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Add status filter if needed
            if (sessions && sessions.length > 0) {
                const activeCount = sessions.filter(s => s.status === true).length;
                const now = new Date();
                const pastCount = sessions.filter(s => new Date(s.scheduled_at) < now).length;
                const todayCount = sessions.filter(s => {
                    const scheduled = new Date(s.scheduled_at);
                    return scheduled.toDateString() === now.toDateString();
                }).length;
                const futureCount = sessions.filter(s => new Date(s.scheduled_at) > now).length;
                
                const header = document.querySelector('.lg\\:w-3\\/4 .mb-6');
                const filterContainer = document.createElement('div');
                filterContainer.className = 'flex flex-wrap gap-2 mb-4';
                filterContainer.innerHTML = `
                    <button onclick="filterSessions('all')" class="px-3 py-1.5 bg-gray-100 text-gray-700 text-xs font-medium rounded hover:bg-gray-200 transition-colors">
                        All (${sessions.length})
                    </button>
                    <button onclick="filterSessions('active')" class="px-3 py-1.5 bg-green-100 text-green-700 text-xs font-medium rounded hover:bg-green-200 transition-colors">
                        Active (${activeCount})
                    </button>
                    <button onclick="filterSessions('today')" class="px-3 py-1.5 bg-blue-100 text-blue-700 text-xs font-medium rounded hover:bg-blue-200 transition-colors">
                        Today (${todayCount})
                    </button>
                    <button onclick="filterSessions('upcoming')" class="px-3 py-1.5 bg-amber-100 text-amber-700 text-xs font-medium rounded hover:bg-amber-200 transition-colors">
                        Upcoming (${futureCount})
                    </button>
                `;
                
                if (header) {
                    header.parentNode.insertBefore(filterContainer, header.nextSibling);
                }
            }
            
            console.log('Sessions page loaded');
        });
        
        // Filter sessions function (basic client-side filtering)
        function filterSessions(filter) {
            const cards = document.querySelectorAll('.session-card');
            cards.forEach(card => {
                const statusText = card.querySelector('.text-xs.font-medium').textContent.toLowerCase();
                const isToday = card.querySelector('.time-badge') !== null;
                
                let show = true;
                switch(filter) {
                    case 'active':
                        show = statusText.includes('active');
                        break;
                    case 'today':
                        show = isToday;
                        break;
                    case 'upcoming':
                        show = statusText.includes('upcoming') || statusText.includes('pending');
                        break;
                    case 'all':
                    default:
                        show = true;
                }
                
                card.style.display = show ? 'block' : 'none';
                card.parentElement.style.display = show ? 'block' : 'none';
            });
        }
    </script>
</body>
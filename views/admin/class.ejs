<style>
    :root {
        --primary: #3bf689;
        --secondary: #e0ec3a;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --info: #0ea5e9;
    }
    
    .detail-card {
        transition: all 0.2s ease;
        border: 1px solid #e5e7eb;
    }
    
    .detail-card:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
    }
    
    .status-active { background-color: #10b981; }
    .status-inactive { background-color: #6b7280; }
    
    .video-thumb {
        width: 60px;
        height: 40px;
        object-fit: cover;
        border-radius: 6px;
    }
    
    .upload-area {
        border: 2px dashed #d1d5db;
        border-radius: 8px;
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    .upload-area:hover {
        border-color: #3b82f6;
        background-color: #f8fafc;
    }
    
    .playlist-item {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        transition: all 0.2s ease;
    }
    
    .playlist-item:hover {
        border-color: #3b82f6;
        background-color: #f8fafc;
    }
    
    .playlist-item.active {
        border-color: #3b82f6;
        background-color: #eff6ff;
    }
</style>

    <!-- Navbar -->
    <%-include('./partials/topnav') %>

    <!-- Sidebar -->
    <%-include('./partials/sidenav') %>

    <!-- Main Content -->
    <div class="container mx-auto px-2 py-4 mt-4">
        <div class="flex flex-col lg:flex-row gap-4">
            <!-- Static Sidebar -->
            <div class="hidden lg:block lg:w-1/4">
                <%-include('./partials/staticsidebar') %>
            </div>

            <!-- Main Content Area -->
            <div class="lg:w-3/4">
                <!-- Header -->
                <div class="mb-6">
                    <div class="flex justify-between items-center">
                        <div>
                            <a href="/<%= backUrl %>" 
                               class="inline-flex items-center gap-2 px-3 py-1.5 bg-white border border-gray-300 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-50 transition-colors mb-2">
                                <i class="fas fa-arrow-left text-xs"></i>
                                Back
                            </a>
                            <h1 class="text-xl font-semibold text-gray-900"><%= singleClass.title %></h1>
                            <p class="text-sm text-gray-500 mt-1"><%= singleClass.description || 'No description provided' %></p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="openEditModal()" 
                                    class="inline-flex items-center gap-2 px-3 py-2 bg-white border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition-colors text-sm">
                                <i class="fas fa-edit text-xs"></i>
                                Edit
                            </button>
                            <form action="/admin/class/<%= singleClass.id %>" method="post" 
                                  onsubmit="return confirm('Delete this session?')">
                                <input type="hidden" name="_method" value="DELETE">
                                <input type="hidden" name="courseId" value="<%= courseId %>">
                                <input type="hidden" name="backUrl" value="<%= backUrl %>">
                                <button type="submit" 
                                        class="inline-flex items-center gap-2 px-3 py-2 bg-red-50 text-red-600 font-medium rounded-lg hover:bg-red-100 transition-colors text-sm">
                                    <i class="fas fa-trash text-xs"></i>
                                    Delete
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <%- include('../partials/messages') %>

                <!-- Stats Overview -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 mb-6">
                    <div class="detail-card bg-white rounded-lg p-4">
                        <div class="flex items-center gap-3">
                            <div class="p-2 rounded-lg bg-blue-100">
                                <i class="fas fa-users text-blue-500 text-sm"></i>
                            </div>
                            <div>
                                <div class="text-lg font-semibold text-gray-900"><%= attendance.length %></div>
                                <div class="text-xs text-gray-500">Attended</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-card bg-white rounded-lg p-4">
                        <div class="flex items-center gap-3">
                            <div class="p-2 rounded-lg bg-green-100">
                                <i class="fas fa-video text-green-500 text-sm"></i>
                            </div>
                            <div>
                                <div class="text-lg font-semibold text-gray-900">
                                    <%= courseVideos ? courseVideos.length : 0 %>
                                </div>
                                <div class="text-xs text-gray-500">Video Parts</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-card bg-white rounded-lg p-4">
                        <div class="flex items-center gap-3">
                            <div class="p-2 rounded-lg bg-purple-100">
                                <i class="fas <%= singleClass.status ? 'fa-play-circle' : 'fa-pause-circle' %> text-purple-500 text-sm"></i>
                            </div>
                            <div>
                                <div class="text-lg font-semibold text-gray-900">
                                    <%= singleClass.status ? 'Active' : 'Inactive' %>
                                </div>
                                <div class="text-xs text-gray-500">Status</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-card bg-white rounded-lg p-4">
                        <div class="flex items-center gap-3">
                            <div class="p-2 rounded-lg bg-amber-100">
                                <i class="fas fa-calendar text-amber-500 text-sm"></i>
                            </div>
                            <div>
                                <div class="text-sm font-semibold text-gray-900">
                                    <%= new Date(singleClass.scheduled_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) %>
                                </div>
                                <div class="text-xs text-gray-500">Scheduled</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Content Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <!-- Left Column (2/3) -->
                    <div class="lg:col-span-2 space-y-4">
                        <!-- Video Player -->
                        <div class="detail-card bg-white rounded-lg">
                            <div class="p-4 border-b border-gray-200">
                                <h3 class="text-sm font-semibold text-gray-900 flex items-center gap-2">
                                    <i class="fas fa-play-circle text-blue-500 text-sm"></i>
                                    Program Video
                                </h3>
                            </div>
                            
                            <div class="p-4">
                                <% if (courseVideos && courseVideos.length > 0) { %>
                                    <div class="bg-black rounded-lg overflow-hidden mb-4">
                                        <video id="mainVideo" 
                                               class="w-full h-64 object-contain"
                                               controls
                                               poster="<%= courseVideos[0]?.thumbnail_url %>">
                                            <source src="<%= courseVideos[0]?.video_url %>" type="video/mp4">
                                            Your browser does not support the video tag.
                                        </video>
                                    </div>
                                    <div>
                                        <h4 class="text-sm font-semibold text-gray-900 mb-1" id="currentVideoTitle">
                                            <%= courseVideos[0].title || 'Part ' + courseVideos[0].part_number %>
                                        </h4>
                                        <div class="flex items-center gap-3 text-xs text-gray-500">
                                            <span>Part <%= courseVideos[0].part_number %></span>
                                            <% if (courseVideos[0].duration) { %>
                                                <span><i class="fas fa-clock text-xs"></i> <%= courseVideos[0].duration %></span>
                                            <% } %>
                                        </div>
                                    </div>
                                <% } else { %>
                                    <div class="text-center py-8">
                                        <i class="fas fa-video-slash text-gray-300 text-3xl mb-3"></i>
                                        <p class="text-sm text-gray-500">No videos uploaded yet</p>
                                    </div>
                                <% } %>
                            </div>
                        </div>

                        <!-- Upload Section -->
                        <div class="detail-card bg-white rounded-lg">
                            <div class="p-4 border-b border-gray-200">
                                <h3 class="text-sm font-semibold text-gray-900 flex items-center gap-2">
                                    <i class="fas fa-cloud-upload-alt text-green-500 text-sm"></i>
                                    Upload Video Part
                                </h3>
                            </div>
                            
                            <div class="p-4">
                                <!-- Removed the inline script here -->

                                <form id="uploadForm">
                                    <input type="hidden" name="classeId" value="<%= singleClass.id %>">
                                    
                                    <div class="space-y-4">
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="block text-xs font-medium text-gray-700 mb-1">Title</label>
                                                <input type="text" 
                                                       name="title" 
                                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                                       placeholder="Video title">
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-gray-700 mb-1">Part #</label>
                                                <input type="number" 
                                                       name="part_number" 
                                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                                       min="1"
                                                       required>
                                            </div>
                                        </div>
                                        
                                        <!-- Video Upload -->
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Video File</label>
                                            <div class="upload-area p-4 text-center" onclick="document.getElementById('videoInput').click()">
                                                <input type="file" 
                                                       id="videoInput" 
                                                       class="hidden"
                                                       accept="video/*"
                                                       required>
                                                <i class="fas fa-file-video text-gray-400 text-lg mb-2"></i>
                                                <p class="text-xs text-gray-500">Click to select video</p>
                                                <p class="text-xs text-gray-400 mt-1" id="videoFileName">No file chosen</p>
                                            </div>
                                        </div>
                                        
                                        <!-- Thumbnail Upload -->
                                        <div>
                                            <label class="block text-xs font-medium text-gray-700 mb-1">Thumbnail</label>
                                            <div class="upload-area p-4 text-center" onclick="document.getElementById('thumbnailInput').click()">
                                                <input type="file" 
                                                       id="thumbnailInput" 
                                                       class="hidden"
                                                       accept="image/*"
                                                       required>
                                                <i class="fas fa-image text-gray-400 text-lg mb-2"></i>
                                                <p class="text-xs text-gray-500">Click to select thumbnail</p>
                                                <p class="text-xs text-gray-400 mt-1" id="thumbnailFileName">No file chosen</p>
                                            </div>
                                        </div>
                                        
                                        <!-- Progress -->
                                        <div id="progressContainer" class="hidden">
                                            <div class="flex justify-between text-xs text-gray-600 mb-1">
                                                <span id="progressStatus">Uploading...</span>
                                                <span id="progressPercent">0%</span>
                                            </div>
                                            <div class="w-full bg-gray-200 rounded-full h-2">
                                                <div id="progressBar" class="bg-blue-500 h-2 rounded-full transition-all" style="width: 0%"></div>
                                            </div>
                                        </div>
                                        
                                        <button type="submit" 
                                                id="uploadBtn"
                                                class="w-full inline-flex items-center justify-center gap-2 px-4 py-2.5 bg-blue-500 text-white text-sm font-medium rounded-lg hover:bg-blue-600 transition-colors">
                                            <i class="fas fa-cloud-upload-alt text-xs"></i>
                                            Upload Video Part
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Session Details -->
                        <div class="detail-card bg-white rounded-lg">
                            <div class="p-4 border-b border-gray-200">
                                <h3 class="text-sm font-semibold text-gray-900 flex items-center gap-2">
                                    <i class="fas fa-info-circle text-gray-500 text-sm"></i>
                                    Session Details
                                </h3>
                            </div>
                            
                            <div class="p-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="space-y-3">
                                        <div>
                                            <label class="text-xs text-gray-500">Title</label>
                                            <p class="text-sm text-gray-900"><%= singleClass.title %></p>
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-500">Description</label>
                                            <p class="text-sm text-gray-900"><%= singleClass.description || '—' %></p>
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-500">Created By</label>
                                            <p class="text-sm text-gray-900"><%= singleClass.crated_by || '—' %></p>
                                        </div>
                                    </div>
                                    
                                    <div class="space-y-3">
                                        <div>
                                            <label class="text-xs text-gray-500">Scheduled</label>
                                            <p class="text-sm text-gray-900">
                                                <%= new Date(singleClass.scheduled_at).toLocaleString('en-US', { 
                                                    month: 'short',
                                                    day: 'numeric',
                                                    hour: 'numeric',
                                                    minute: '2-digit'
                                                }) %>
                                            </p>
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-500">Meeting Link</label>
                                            <a href="<%= singleClass.meet_link %>" 
                                               target="_blank"
                                               class="text-sm text-blue-600 hover:text-blue-700 inline-flex items-center gap-1">
                                                <i class="fas fa-external-link-alt text-xs"></i>
                                                Join Meeting
                                            </a>
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-500">Join Code</label>
                                            <p class="text-sm text-gray-900"><%= singleClass.join_code || '—' %></p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-4 pt-4 border-t border-gray-100">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-2">
                                            <label class="text-xs text-gray-500">Link Visibility</label>
                                            <span class="text-xs font-medium <%= singleClass.show_link ? 'text-green-600' : 'text-gray-600' %>">
                                                <%= singleClass.show_link ? 'Visible' : 'Hidden' %>
                                            </span>
                                        </div>
                                        <form action="/admin/class/<%= singleClass.id %>/<%= singleClass.show_link ? 'false' : 'true' %>" method="post">
                                            <input type="hidden" name="_method" value="PUT">
                                            <input type="hidden" name="courseId" value="<%= courseId %>">
                                            <button type="submit" 
                                                    class="text-xs text-blue-600 hover:text-blue-700">
                                                <%= singleClass.show_link ? 'Hide' : 'Show' %>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column (1/3) -->
                    <div class="space-y-4">
                        <!-- Video Playlist -->
                        <% if (courseVideos && courseVideos.length > 0) { %>
                            <div class="detail-card bg-white rounded-lg">
                                <div class="p-4 border-b border-gray-200">
                                    <h3 class="text-sm font-semibold text-gray-900 flex items-center justify-between">
                                        <span class="flex items-center gap-2">
                                            <i class="fas fa-list text-gray-500 text-sm"></i>
                                            Playlist
                                        </span>
                                        <span class="text-xs text-gray-500"><%= courseVideos.length %> videos</span>
                                    </h3>
                                </div>
                                
                                <div class="p-4">
                                    <div class="space-y-2 max-h-96 overflow-y-auto">
                                        <% courseVideos.forEach((video, index) => { %>
                                            <div class="playlist-item <%= index === 0 ? 'active' : '' %>"
                                                 onclick="loadVideo('<%= video.video_url %>', '<%= video.thumbnail_url %>', '<%= video.title %>', <%= video.part_number %>, this)">
                                                <div class="flex items-center gap-3">
                                                    <img src="<%= video.thumbnail_url %>" 
                                                         alt="Thumbnail"
                                                         class="video-thumb">
                                                    <div class="flex-1 min-w-0">
                                                        <p class="text-sm font-medium text-gray-900 truncate">
                                                            <%= video.title || 'Part ' + video.part_number %>
                                                        </p>
                                                        <div class="flex items-center gap-2 text-xs text-gray-500">
                                                            <span>Part <%= video.part_number %></span>
                                                            <% if (video.duration) { %>
                                                                <span><i class="fas fa-clock text-xs"></i> <%= video.duration %></span>
                                                            <% } %>
                                                        </div>
                                                    </div>
                                                    <form action="/admin/class/video/delete" 
                                                          method="POST"
                                                          onsubmit="return confirm('Delete this video?')">
                                                        <input type="hidden" name="_method" value="DELETE">
                                                        <input type="hidden" name="classVideoId" value="<%= video.id %>">
                                                        <input type="hidden" name="backUrl" value="<%= backUrl %>">                                                        <input type="hidden" name="class_id" value="<%= video.class_id %>">
                                                        <input type="hidden" name="video_public_id" value="<%= video.video_public_id %>">
                                                        <input type="hidden" name="thumbnail_public_id" value="<%= video.thumbnail_public_id %>">
                                                        <button type="submit" 
                                                                class="text-red-500 hover:text-red-600">
                                                            <i class="fas fa-trash text-xs"></i>
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                        <% }) %>
                                    </div>
                                </div>
                            </div>
                        <% } %>

                        <!-- Attendance -->
                        <div class="detail-card bg-white rounded-lg">
                            <div class="p-4 border-b border-gray-200">
                                <h3 class="text-sm font-semibold text-gray-900 flex items-center justify-between">
                                    <span class="flex items-center gap-2">
                                        <i class="fas fa-users text-gray-500 text-sm"></i>
                                        Attendance
                                    </span>
                                    <span class="text-xs text-gray-500"><%= attendance.length %> students</span>
                                </h3>
                            </div>
                            
                            <div class="p-4">
                                <% if (attendance.length === 0) { %>
                                    <div class="text-center py-4">
                                        <i class="fas fa-user-slash text-gray-300 text-lg mb-2"></i>
                                        <p class="text-xs text-gray-500">No students attended</p>
                                    </div>
                                <% } else { %>
                                    <div class="space-y-3 max-h-64 overflow-y-auto">
                                        <% attendance.forEach(function(user) { %>
                                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                                <div>
                                                    <p class="text-sm font-medium text-gray-900"><%= user.full_name || 'Student' %></p>
                                                    <p class="text-xs text-gray-500"><%= user.email %></p>
                                                    <p class="text-xs text-gray-400 mt-1">
                                                        <%= new Date(user.joined_at).toLocaleTimeString('en-US', { 
                                                            hour: 'numeric',
                                                            minute: '2-digit'
                                                        }) %>
                                                    </p>
                                                </div>
                                                <form action="/admin/class/<%= singleClass.id %>/grant-access/<%= user.id %>" 
                                                      method="post">
                                                    <input type="hidden" name="_method" value="PUT">
                                                    <label class="inline-flex items-center cursor-pointer">
                                                        <input type="checkbox" 
                                                               name="granted" 
                                                               class="sr-only peer"
                                                               onchange="this.form.submit()"
                                                               <%= user.status ? 'checked' : '' %>>
                                                        <div class="relative w-10 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-500"></div>
                                                    </label>
                                                </form>
                                            </div>
                                        <% }) %>
                                    </div>
                                <% } %>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="detail-card bg-white rounded-lg">
                            <div class="p-4 border-b border-gray-200">
                                <h3 class="text-sm font-semibold text-gray-900 flex items-center gap-2">
                                    <i class="fas fa-bolt text-gray-500 text-sm"></i>
                                    Quick Actions
                                </h3>
                            </div>
                            
                            <div class="p-4">
                                <div class="space-y-2">
                                    <a href="<%= singleClass.meet_link %>" 
                                       target="_blank"
                                       class="flex items-center gap-2 px-3 py-2 text-blue-600 hover:bg-blue-50 rounded-lg text-sm transition-colors">
                                        <i class="fas fa-video text-xs"></i>
                                        Join Meeting
                                    </a>
                                    
                                    <button onclick="openEditModal()"
                                            class="w-full flex items-center gap-2 px-3 py-2 text-gray-700 hover:bg-gray-50 rounded-lg text-sm transition-colors">
                                        <i class="fas fa-edit text-xs"></i>
                                        Edit Details
                                    </button>
                                    
                                    <% if (!singleClass.is_complete) { %>
                                        <form action="/admin/class/complete/<%= singleClass.id %>" method="post">
                                            <input type="hidden" name="courseId" value="<%= courseId %>">
                                            <button type="submit" 
                                                    class="w-full flex items-center gap-2 px-3 py-2 text-green-600 hover:bg-green-50 rounded-lg text-sm transition-colors"
                                                    onclick="return confirm('Mark session as complete?')">
                                                <i class="fas fa-check text-xs"></i>
                                                Mark Complete
                                            </button>
                                        </form>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-lg max-w-lg w-full">
                <div class="p-5">
                    <div class="flex justify-between items-center mb-5">
                        <h3 class="text-lg font-semibold text-gray-900">Edit Session</h3>
                        <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-500">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <form method="post" action="/admin/class/<%= singleClass.id %>/edit">
                        <input type="hidden" name="_method" value="PUT">
                        <input type="hidden" name="courseId" value="<%= courseId %>">
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                                <input type="text" 
                                       name="title" 
                                       value="<%= singleClass.title %>"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                       required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Scheduled Date & Time</label>
                                <input type="datetime-local" 
                                       name="scheduled_at" 
                                       value="<%= new Date(singleClass.scheduled_at).toISOString().slice(0, 16) %>"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                       required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                <textarea name="description" 
                                          rows="3"
                                          class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                          required><%= singleClass.description %></textarea>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Meeting Link</label>
                                <input type="url" 
                                       name="meet_link" 
                                       value="<%= singleClass.meet_link %>"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            </div>
                        </div>
                        
                        <div class="flex justify-end gap-2 mt-6 pt-5 border-t border-gray-200">
                            <button type="button" 
                                    onclick="closeEditModal()"
                                    class="px-4 py-2 border border-gray-300 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-50">
                                Cancel
                            </button>
                            <button type="submit" 
                                    class="px-4 py-2 bg-blue-500 text-white text-sm font-medium rounded-lg hover:bg-blue-600">
                                Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

<script>
    // Cloudinary configuration - defined once at the top
    const cloudName = '<%= process.env.CLOUD_NAME %>';
    const uploadPreset = '<%= process.env.CLOUDINARY_UPLOAD_PRESET || "admin-videos" %>';

    // Check Cloudinary config and show warning if needed
    if (!cloudName || !uploadPreset) {
        console.warn('Cloudinary configuration is missing');
        // You could optionally show a warning in the UI here
    }

    // Modal functions
    function openEditModal() {
        document.getElementById('editModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeEditModal() {
        document.getElementById('editModal').classList.add('hidden');
        document.body.style.overflow = 'auto';
    }

    // Video loading function
    function loadVideo(url, poster, title, partNumber, element) {
        const video = document.getElementById('mainVideo');
        if (video) {
            video.src = url;
            video.poster = poster;
            video.load();
            
            const titleElement = document.getElementById('currentVideoTitle');
            if (titleElement) {
                titleElement.textContent = title;
            }
            
            // Update active state
            document.querySelectorAll('.playlist-item').forEach(item => {
                item.classList.remove('active');
            });
            element.classList.add('active');
        }
    }

    // File input handlers
    document.addEventListener('DOMContentLoaded', function() {
        const videoInput = document.getElementById('videoInput');
        const thumbnailInput = document.getElementById('thumbnailInput');
        
        // File name display handlers
        if (videoInput) {
            videoInput.addEventListener('change', function(e) {
                const fileName = e.target.files[0]?.name || 'No file chosen';
                const fileNameElement = document.getElementById('videoFileName');
                if (fileNameElement) {
                    fileNameElement.textContent = fileName;
                }
            });
        }
        
        if (thumbnailInput) {
            thumbnailInput.addEventListener('change', function(e) {
                const fileName = e.target.files[0]?.name || 'No file chosen';
                const fileNameElement = document.getElementById('thumbnailFileName');
                if (fileNameElement) {
                    fileNameElement.textContent = fileName;
                }
            });
        }

        // Upload form handling
        const form = document.getElementById('uploadForm');
        if (form) {
            // Check if Cloudinary is configured
            if (!cloudName || !uploadPreset) {
                const uploadBtn = document.getElementById('uploadBtn');
                if (uploadBtn) {
                    uploadBtn.disabled = true;
                    uploadBtn.innerHTML = '<i class="fas fa-exclamation-triangle text-xs"></i> Upload Disabled';
                    uploadBtn.className = 'w-full inline-flex items-center justify-center gap-2 px-4 py-2.5 bg-gray-300 text-gray-500 text-sm font-medium rounded-lg cursor-not-allowed';
                    
                    // Show warning message
                    const warningDiv = document.createElement('div');
                    warningDiv.className = 'mb-4 p-3 bg-amber-50 border border-amber-200 rounded-lg';
                    warningDiv.innerHTML = `
                        <div class="flex items-center gap-2 text-sm text-amber-700">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>Upload configuration required</span>
                        </div>
                    `;
                    form.parentNode.insertBefore(warningDiv, form);
                }
                return;
            }

            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const videoFile = document.getElementById('videoInput')?.files[0];
                const thumbnailFile = document.getElementById('thumbnailInput')?.files[0];
                const partNumber = form.querySelector('input[name="part_number"]')?.value;
                const title = form.querySelector('input[name="title"]')?.value;
                const classeId = form.querySelector('input[name="classeId"]')?.value;
                
                // Basic validation
                if (!videoFile || !thumbnailFile || !partNumber) {
                    alert('Please fill all required fields');
                    return;
                }

                // Show progress
                const progressContainer = document.getElementById('progressContainer');
                const progressBar = document.getElementById('progressBar');
                const progressPercent = document.getElementById('progressPercent');
                const progressStatus = document.getElementById('progressStatus');
                const uploadBtn = document.getElementById('uploadBtn');
                
                if (progressContainer) progressContainer.classList.remove('hidden');
                if (uploadBtn) {
                    uploadBtn.disabled = true;
                    uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin text-xs"></i> Uploading...';
                }
                
                try {
                    if (progressStatus) progressStatus.textContent = 'Uploading to Cloudinary...';
                    
                    // Upload files in parallel
                    const [videoResult, thumbnailResult] = await Promise.all([
                        uploadToCloudinary(videoFile, 'video'),
                        uploadToCloudinary(thumbnailFile, 'image')
                    ]);
                    
                    if (progressStatus) progressStatus.textContent = 'Saving to database...';
                    if (progressBar) progressBar.style.width = '100%';
                    if (progressPercent) progressPercent.textContent = '100%';
                    
                    // Save to database
                    const saveResult = await fetch('/admin/class/video-part-save', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            title,
                            part_number: partNumber,
                            classeId,
                            videoUrl: videoResult.secure_url,
                            thumbnailUrl: thumbnailResult.secure_url,
                            videoPublicId: videoResult.public_id,
                            thumbnailPublicId: thumbnailResult.public_id
                        })
                    });
                    
                    if (saveResult.ok) {
                        alert('Video uploaded successfully!');
                        window.location.reload();
                    } else {
                        throw new Error('Failed to save video');
                    }
                    
                } catch (error) {
                    console.error('Upload failed:', error);
                    alert('Upload failed: ' + error.message);
                    resetForm();
                }
            });
        }
        
        // Close modal on outside click
        const editModal = document.getElementById('editModal');
        if (editModal) {
            editModal.addEventListener('click', function(e) {
                if (e.target === this) closeEditModal();
            });
        }
        
        // Escape key to close modal
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeEditModal();
        });
    });

    // Cloudinary upload function
    async function uploadToCloudinary(file, resourceType) {
        return new Promise((resolve, reject) => {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', uploadPreset);
            
            const xhr = new XMLHttpRequest();
            
            // Progress tracking
            xhr.upload.addEventListener('progress', function(e) {
                if (e.lengthComputable) {
                    const percent = (e.loaded / e.total) * 100;
                    const progressBar = document.getElementById('progressBar');
                    const progressPercent = document.getElementById('progressPercent');
                    if (progressBar && progressPercent) {
                        progressBar.style.width = `${percent}%`;
                        progressPercent.textContent = `${Math.round(percent)}%`;
                    }
                }
            });
            
            xhr.onload = function() {
                if (xhr.status === 200) {
                    resolve(JSON.parse(xhr.responseText));
                } else {
                    reject(new Error(`Upload failed: ${xhr.statusText}`));
                }
            };
            
            xhr.onerror = function() {
                reject(new Error('Network error during upload'));
            };
            
            xhr.open('POST', `https://api.cloudinary.com/v1_1/${cloudName}/${resourceType}/upload`);
            xhr.send(formData);
        });
    }

    function resetForm() {
        const form = document.getElementById('uploadForm');
        if (form) form.reset();
        
        const progressContainer = document.getElementById('progressContainer');
        const uploadBtn = document.getElementById('uploadBtn');
        
        if (progressContainer) progressContainer.classList.add('hidden');
        if (uploadBtn) {
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = '<i class="fas fa-cloud-upload-alt text-xs"></i> Upload Video Part';
        }
        
        // Reset file name displays
        const videoFileName = document.getElementById('videoFileName');
        const thumbnailFileName = document.getElementById('thumbnailFileName');
        if (videoFileName) videoFileName.textContent = 'No file chosen';
        if (thumbnailFileName) thumbnailFileName.textContent = 'No file chosen';
    }
</script>
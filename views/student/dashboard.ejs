<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Student Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Custom Styles -->
  <link rel="stylesheet" href="/style.css">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
    crossorigin="anonymous" />

</head>

<body>

  <div class="container-fluid vh-100">
    <div class="row h-100">

      <!-- Sidebar -->
      <%- include('./partials/sidenav') %>

        <!-- Main content -->
        <div class="col-md-10 bg-white border">

          <!-- Top Info -->
          <div class="container mt-4 mb-2">
            <div class="row align-items-center">
              <div class="col-md-9">
                <h2>Hello, <%= user.full_name %>
                </h2>
                <p class="text-muted">Welcome Back</p>
              </div>
              <div class="col-md-3 text-end">
                <% if (!user.is_affiliate) { %>
                  <a href="/affiliate/signup" class="btn btn-success">
                    <i class="fa fa-plus"></i> Refer To Earn
                  </a>
                  <% } %>
              </div>
            </div>
            <%- include('../partials/messages') %>
          </div>

          <!-- Main Body -->
          <div class="row">
            <!-- Middle Content -->
            <div class="col-md-12">
              <div class="container">

                <% if (user.has_paid) { %>
                  <!-- ========== PAID USER DASHBOARD ========== -->
                  <section class=" mb-5">

                    <div class="row ">
                      <div class="col-md-4 mb-3">
                        <div class="bg-light p-3 rounded text-center">
                          <img src="/images/video-call.png" alt="Videos" style="max-width: 50px;">
                          <h6 class="mt-2">Upcoming Classes</h6>
                        </div>
                      </div>

                      <div class="col-md-4 mb-3">
                        <div class="bg-light p-3 rounded text-center">
                          <img src="/images/checked.png" alt="Watched" style="max-width: 50px;">
                          <h6 class="mt-2">Classes Attended</h6>
                        </div>
                      </div>

                      <div class="col-md-4 mb-3">
                        <div class="bg-light p-3 rounded text-center">
                          <img src="/images/cancel.png" alt="Watched" style="max-width: 50px;">
                          <h6 class="mt-2">Classes Missed</h6>
                        </div>
                      </div>
                    </div>
                  </section>

                  <section class="week-wrapper mt-5">
                    <h5>Class Activities</h5>
                    <div class="row">
                      <div class="col-md-8">
                        <div class="border p-4">
                            <div class="row">                          
                            <% sessions.forEach(function(data) {
                              const scheduled = new Date(data.scheduled_at);
                              const now = new Date();
                              const isToday = scheduled.toDateString() === now.toDateString();
                              const isFuture = scheduled > now;
                              const isPast = scheduled < now;

                              let statusText = '';
                              let statusClass = '';
                              let showJoin = false;
                              let showRejoin = false;

                              if (!data.status) {
                                statusText = 'Pending';
                                statusClass = 'bg-secondary';
                              } else if (data.is_joined && isToday) {
                                statusText = 'Attended';
                                statusClass = 'bg-success';
                                showRejoin = true;
                              } else if (!data.is_joined && isToday) {
                                statusText = 'ongoing';
                                statusClass = 'bg-primary';
                                showJoin = true;
                              } else if (!data.is_joined && isFuture) {
                                statusText = 'Upcoming';
                                statusClass = 'bg-info';
                              } else if (isPast) {
                                statusText = 'Closed Session';
                                statusClass = 'bg-danger';
                              }
                            %>

                    <div class="col-md-3 mb-3">
                      <div class="p-3 border rounded shadow-sm class-card d-flex flex-column justify-content-between">

                        <!-- Top: Status -->
                        <div class="d-flex justify-content-between mb-2">
                          <span class="badge <%= statusClass %>"><%= statusText %></span>
                        </div>

                        <!-- Middle: Title and Date -->
                        <div class="mb-2">
                          <h6 class="mb-1 text-truncate" title="<%= data.title %>"><%= data.title %></h6>
                          <p class="text-muted small mb-0" style="font-size: 11px;">
                            <%= scheduled.toLocaleString('en-US', {
                              year: 'numeric',
                              month: 'long',
                              day: 'numeric',
                              hour: 'numeric',
                              minute: '2-digit'
                            }) %>
                          </p>
                        </div>

                              <!-- Bottom: Action -->
                              <div>
                                <% if (showRejoin) { %>
                                  <a href="/class/<%= data.join_code %>" class="btn btn-sm btn-outline-success">Rejoin</a>
                                <% } else if (showJoin) { %>
                                  <a href="/class/<%= data.join_code %>" class="btn btn-sm btn-outline-primary">Join</a>
                                <% } %>
                              </div>

                            </div>
                          </div>

                        <% }) %>
                      </div>

                   </div>  <!-- border ends -->
                </div> <!-- col-8 ends -->

                      <div class="col-md-4">
                        <div class="p-4 bg-success text-white rounded text-center">
                          <blockquote class="blockquote mb-0">
                            <p>"Knowledge is power. Information is liberating. Education is the premise of progress."
                            </p>
                            <footer class="blockquote-footer text-white-50 mt-2">— Kofi Annan</footer>
                          </blockquote>
                        </div>
                      </div>
                    </div> <!--row ends hrer-->

                    <br>
                    <br>

                     <h5>Ebooks</h5>
                    <div class="row">
                      <div class="col-md-12">
                        <div class="border p-4 mb-5">
                          <% if (ebooks.length === 0) { %>
                            <div class="text-center py-5 text-muted">
                              <i class="fas fa-book fa-2x mb-3"></i>
                              <p class="mb-0">No ebooks available at the moment.</p>
                            </div>
                          <% } else { %>
                            <div class="row">
                              <% ebooks.forEach(function(data) { %>
                                <div class="col-md-3 mb-3">
                                  <div class="p-3 border rounded shadow-sm class-card d-flex flex-column justify-content-between">

                                    <!-- Top: Status -->
                                    <div class="d-flex justify-content-between mb-2">
                                      <% 
                                        const statusText = data.is_free ? 'Free' : 'Premium';
                                        const statusClass = data.is_free ? 'bg-success' : 'bg-warning text-dark'; 
                                      %>
                                      <span class="badge <%= statusClass %>"><%= statusText %></span>
                                    </div>

                                    <!-- Middle: Title -->
                                    <div class="mb-2">
                                      <h6 class="mb-1 text-truncate" title="<%= data.title %>"><%= data.title %></h6>
                                      <% if (data.author) { %>
                                        <p class="text-muted small mb-0" style="font-size: 11px;">
                                          <strong>By:</strong> <%= data.author %>
                                        </p>
                                      <% } %>
                                    </div>

                                    <!-- Bottom: Action -->
                                    <div>
                                      <a href="<%= data.link %>" target="_blank" class="btn btn-sm btn-outline-primary w-100">Read</a>
                                    </div>

                                  </div>
                                </div>
                              <% }) %>
                            </div>
                          <% } %>
                        </div>
                      </div>

                    </div>

                  </section>

                  <% } else { %>
                    <!-- ========== UNPAID USER ========== -->
                    <div class="text-center p-5 bg-light border rounded mb-4">
                      <h3 class="mb-3">Unlock Full Access</h3>
                      <p class="lead">Pay ₦<%= customerToPay %> to unlock all classes and history features.</p>
                      <form id="paymentForm">
                        <input type="hidden" id="email" value="<%= user.email %>">
                        <input type="hidden" id="amount" value="<%= customerToPay %>">
                        <% if (affiliateAgent) { %>
                          <input type="hidden" id="referrerId" value="<%= affiliateAgent %>">
                          <% } %>
                            <button type="submit" class="btn btn-outline-success">Pay <%= customerToPay %> Now</button>
                      </form>

                      <small class="d-block mt-3 text-muted">
                        <i class="bi bi-shield-lock"></i> Secured by <a href="https://paystack.com"
                          target="_blank">Paystack</a>
                      </small>
                    </div>
                    <% } %>

              </div>
            </div>

     
          </div>
        </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Paystack -->
  <script src="https://js.paystack.co/v1/inline.js"></script>
  <script>
    paymentForm.addEventListener("submit", function (e) {
      e.preventDefault();

      const email = document.getElementById("email").value;
      const amount = parseFloat(document.getElementById("amount").value);
      const referrerId = document.getElementById("referrerId")?.value || null;

      fetch('/pay', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, amount, referrerId })
      })
        .then(res => res.json())
        .then(data => {
          if (data.status) {
            window.location.href = data.data.authorization_url;
          } else {
            alert(data.message || 'Payment failed.');
          }
        })
        .catch(err => {
          console.error(err);
          alert('Error processing payment.');
        });
    });

  </script>

</body>

</html>
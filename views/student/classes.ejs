<!-- Navbar -->
<%-include('./partials/topnav') %>

<!-- Sidebar -->
<%-include('./partials/sidenav') %>

<!-- Main Content -->
<div class="min-h-screen bg-gray-50">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <div class="flex flex-col lg:flex-row gap-6">
      <!-- Static Sidebar for Desktop -->
      <div class="hidden lg:block lg:w-1/4">
        <%-include('./partials/staticsidebar') %>
      </div>

      <!-- Main Content Area -->
      <div class="lg:w-3/4">
        <!-- Header -->
        <div class="mb-8">
          <a href="/user/category/<%=categoryId%>" 
             class="inline-flex items-center gap-2 text-sm text-gray-600 hover:text-gray-900 mb-4 group">
            <i class="fas fa-arrow-left text-xs group-hover:-translate-x-1 transition-transform"></i>
            Back
          </a>
          
          <div class="mb-4">
            <h1 class="text-xl font-bold text-gray-900">Schedules</h1>
            <p class="text-sm text-gray-500">Class sessions for <span class="font-medium text-gray-700"><%= courses.title %></span></p>
          </div>
          
          <%- include('../partials/messages') %>
        </div>

        <!-- Course Card -->
        <div class="bg-gradient-to-r from-green-50 to-green-70 rounded-xl border border-green-100 p-5 mb-6 shadow-sm">
          <div class="flex items-start gap-4">
            <div class="flex-shrink-0 w-12 h-12 rounded-lg bg-gradient-to-br from-green-500 to-green-600 flex items-center justify-center">
              <i class="fas fa-graduation-cap text-white text-lg"></i>
            </div>
            <div class="flex-1">
              <h2 class="text-lg font-semibold text-gray-900 mb-1"><%= courses.title %></h2>
              <p class="text-sm text-gray-600 mb-3"><%= courses.description %></p>
              
              <% if (courses.takeaways && courses.takeaways.length > 0) { %>
                <div class="flex flex-wrap gap-2">
                  <% courses.takeaways.slice(0, 3).forEach(function(takeaway) { %>
                    <span class="inline-flex items-center gap-1 px-2 py-1 bg-white border border-green-100 text-green-700 text-xs rounded-lg">
                      <i class="fas fa-check text-xs"></i>
                      <%= takeaway %>
                    </span>
                  <% }); %>
                  <% if (courses.takeaways.length > 3) { %>
                    <span class="inline-flex items-center gap-1 px-2 py-1 bg-white border border-green-100 text-green-700 text-xs rounded-lg">
                      +<%= courses.takeaways.length - 3 %> more
                    </span>
                  <% } %>
                </div>
              <% } %>
            </div>
          </div>
        </div>

        <!-- Completion Banner -->
        <% if (allSessionsComplete) { %>
          <div class="bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl p-5 mb-6 shadow-md">
            <div class="flex items-center gap-4">
              <div class="flex-shrink-0">
                <div class="w-10 h-10 rounded-full bg-white bg-opacity-20 flex items-center justify-center">
                  <i class="fas fa-trophy text-white text-lg"></i>
                </div>
              </div>
              <div class="flex-1">
                <h3 class="font-semibold text-white mb-1">Program Completed!</h3>
                <p class="text-sm text-green-100 opacity-90">You've successfully completed all sessions. Lifetime access to recordings and materials.</p>
              </div>
            </div>
          </div>
        <% } %>

        <!-- Sessions -->
       <div class="mb-8">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-base font-semibold text-gray-900">Class Sessions</h2>
            <span class="text-sm text-gray-500">
              <%= sessions.length %> session<%= sessions.length !== 1 ? 's' : '' %>
            </span>
          </div>
          
          <% if (sessions.length === 0) { %>
            <!-- Empty State -->
            <div class="bg-white rounded-lg border border-gray-200 p-8 text-center">
              <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-calendar-times text-gray-400"></i>
              </div>
              <p class="text-sm text-gray-500">No sessions scheduled yet</p>
            </div>
          <% } else { %>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <% 
              sessions.forEach(function(data, index) {
                const scheduled = new Date(data.scheduled_at);
                const now = new Date();
                const isToday = scheduled.toDateString() === now.toDateString();
                const isFuture = scheduled > now;
                const isPast = scheduled < now;
                const timeDiff = scheduled.getTime() - now.getTime();
                const hoursUntil = timeDiff / (1000 * 60 * 60);
                
                // Determine status and colors
                let status = '';
                let cardColor = 'gray';
                let borderColor = 'gray';
                let icon = 'clock';
                let action = 'none';
                let buttonText = '';
                let buttonLink = '#';
                
                // Status logic
                if (allSessionsComplete && isPast) {
                  status = 'Completed';
                  cardColor = 'green';
                  borderColor = 'green';
                  icon = 'check-circle';
                  action = 'recording';
                  buttonText = 'Recording';
                  buttonLink = `/user/class/${data.id}/course/${courseId}/category/${categoryId}`;
                } 
                else if (data.is_joined && isToday) {
                  status = 'Active';
                  cardColor = 'green';
                  borderColor = 'green';
                  icon = 'play-circle';
                  action = 'join';
                  buttonText = 'Rejoin';
                  buttonLink = `/class/${data.join_code}/${data.id}`;
                }
                else if (!data.is_joined && isToday) {
                  const joinWindowStart = new Date(scheduled.getTime() - (15 * 60 * 1000));
                  const joinWindowEnd = new Date(scheduled.getTime() + (30 * 60 * 1000));
                  
                  if (now >= joinWindowStart && now <= joinWindowEnd) {
                    status = 'Join Now';
                    cardColor = 'green';
                    borderColor = 'green';
                    icon = 'sign-in-alt';
                    action = 'join';
                    buttonText = 'Join';
                    buttonLink = `/class/${data.join_code}/${data.id}`;
                  } else if (now < joinWindowStart) {
                    status = 'Upcoming';
                    cardColor = 'blue';
                    borderColor = 'blue';
                    icon = 'clock';
                    buttonText = `In ${Math.ceil((joinWindowStart.getTime() - now.getTime()) / (1000 * 60))} min`;
                  } else {
                    status = 'Too Late';
                    cardColor = 'red';
                    borderColor = 'red';
                    icon = 'clock';
                    action = 'recording';
                    buttonText = 'Recording';
                    buttonLink = `/user/class/${data.id}/course/${courseId}/category/${categoryId}`;
                  }
                }
                else if (isFuture) {
                  status = 'Upcoming';
                  cardColor = 'blue';
                  borderColor = 'blue';
                  icon = 'calendar';
                  buttonText = hoursUntil < 24 ? `${Math.ceil(hoursUntil)}h` : 'Upcoming';
                }
                else if (isPast && data.is_joined && !isToday) {
                  status = 'Completed';
                  cardColor = 'green';
                  borderColor = 'green';
                  icon = 'check-circle';
                  action = 'recording';
                  buttonText = 'Recording';
                  buttonLink = `/user/class/${data.id}/course/${courseId}/category/${categoryId}`;
                }
                else if (isPast && !data.is_joined && !isToday) {
                  status = 'Missed';
                  cardColor = 'red';
                  borderColor = 'red';
                  icon = 'times-circle';
                  action = 'recording';
                  buttonText = 'Recording';
                  buttonLink = `/user/class/${data.id}/course/${courseId}/category/${categoryId}`;
                }
                
                // Time display
                const timeDisplay = scheduled.toLocaleDateString('en-US', { 
                  month: 'short', 
                  day: 'numeric' 
                }) + ' • ' + scheduled.toLocaleTimeString([], { 
                  hour: '2-digit', 
                  minute: '2-digit' 
                });
              %>
              
              <!-- Session Card -->
              <div class="bg-white rounded-lg border-l-4 <%= 
                borderColor === 'green' ? 'border-green-500' :
                borderColor === 'blue' ? 'border-blue-500' :
                borderColor === 'red' ? 'border-red-500' :
                'border-gray-300'
              %> shadow-sm hover:shadow transition-shadow">
                <div class="p-4">
                  <!-- Header -->
                  <div class="flex justify-between items-start mb-3">
                    <div>
                      <div class="flex items-center gap-2 mb-1">
                        <div class="w-8 h-8 rounded-lg <%= 
                          cardColor === 'green' ? 'bg-green-50 text-green-600' :
                          cardColor === 'blue' ? 'bg-blue-50 text-blue-600' :
                          cardColor === 'red' ? 'bg-red-50 text-red-600' :
                          'bg-gray-50 text-gray-600'
                        %> flex items-center justify-center">
                          <i class="fas fa-<%= icon %> text-sm"></i>
                        </div>
                        <h3 class="text-sm font-semibold text-gray-900"><%= data.title %></h3>
                      </div>
                      <div class="text-xs text-gray-500">
                        Session <%= index + 1 %> • <%= timeDisplay %>
                      </div>
                    </div>
                    <span class="px-2 py-1 text-xs font-medium rounded <%= 
                      cardColor === 'green' ? 'bg-green-100 text-green-800' :
                      cardColor === 'blue' ? 'bg-blue-100 text-blue-800' :
                      cardColor === 'red' ? 'bg-red-100 text-red-800' :
                      'bg-gray-100 text-gray-800'
                    %>">
                      <%= status %>
                    </span>
                  </div>
                  
                  <!-- Description -->
                  <% if (data.description) { %>
                    <p class="text-sm text-gray-600 mb-4 line-clamp-2"><%= data.description %></p>
                  <% } %>
                  
                  <!-- Details -->
                  <div class="flex items-center gap-3 text-xs text-gray-500 mb-4">
                    <div class="flex items-center gap-1">
                      <i class="fas fa-user text-gray-400"></i>
                      <span><%= data.teacher %></span>
                    </div>
                  </div>
                  
                  <!-- Action Button -->
                  <div>
                    <% if (action === 'join') { %>
                      <a href="<%= buttonLink %>" 
                         class="block w-full text-center text-sm font-medium text-white <%= 
                           cardColor === 'green' ? 'bg-green-500 hover:bg-green-600' :
                           'bg-blue-500 hover:bg-blue-600'
                         %> py-2 rounded-lg transition-colors">
                        <i class="fas fa-sign-in-alt text-xs mr-2"></i>
                        <%= buttonText %>
                      </a>
                    <% } else if (action === 'recording') { %>
                      <a href="<%= buttonLink %>" 
                         class="block w-full text-center text-sm font-medium text-white bg-purple-500 hover:bg-purple-600 py-2 rounded-lg transition-colors">
                        <i class="fas fa-video text-xs mr-2"></i>
                        <%= buttonText %>
                      </a>
                    <% } else { %>
                      <div class="text-center text-sm font-medium <%= 
                        cardColor === 'blue' ? 'text-blue-600 bg-blue-50' :
                        cardColor === 'red' ? 'text-red-600 bg-red-50' :
                        'text-gray-600 bg-gray-50'
                      %> py-2 rounded-lg">
                        <%= buttonText %>
                      </div>
                    <% } %>
                  </div>
                </div>
              </div>
              <% }); %>
            </div>
          <% } %>
        </div>

        <!-- Resources Section -->
        <% if (allSessionsComplete) { %>
          <div class="mt-8">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Course Resources</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <a href="/user/course/<%=courseId%>/recordings" 
                 class="group bg-white border border-gray-200 rounded-xl p-5 hover:border-blue-300 hover:shadow-md transition-all duration-200">
                <div class="flex items-center gap-3 mb-3">
                  <div class="w-10 h-10 rounded-lg bg-blue-50 flex items-center justify-center group-hover:bg-blue-100 transition-colors">
                    <i class="fas fa-video text-blue-500"></i>
                  </div>
                  <div>
                    <h4 class="font-semibold text-gray-900">Session Recordings</h4>
                    <p class="text-xs text-gray-500">All class recordings</p>
                  </div>
                </div>
                <div class="flex items-center text-sm text-blue-600 group-hover:text-blue-700">
                  View recordings
                  <i class="fas fa-arrow-right ml-2 text-xs transition-transform group-hover:translate-x-1"></i>
                </div>
              </a>
              
              <a href="/user/course/<%=courseId%>/materials" 
                 class="group bg-white border border-gray-200 rounded-xl p-5 hover:border-green-300 hover:shadow-md transition-all duration-200">
                <div class="flex items-center gap-3 mb-3">
                  <div class="w-10 h-10 rounded-lg bg-green-50 flex items-center justify-center group-hover:bg-green-100 transition-colors">
                    <i class="fas fa-file-alt text-green-500"></i>
                  </div>
                  <div>
                    <h4 class="font-semibold text-gray-900">Course Materials</h4>
                    <p class="text-xs text-gray-500">Downloadable resources</p>
                  </div>
                </div>
                <div class="flex items-center text-sm text-green-600 group-hover:text-green-700">
                  Access materials
                  <i class="fas fa-arrow-right ml-2 text-xs transition-transform group-hover:translate-x-1"></i>
                </div>
              </a>
              
              <button class="group bg-white border border-gray-200 rounded-xl p-5 hover:border-purple-300 hover:shadow-md transition-all duration-200 text-left">
                <div class="flex items-center gap-3 mb-3">
                  <div class="w-10 h-10 rounded-lg bg-purple-50 flex items-center justify-center group-hover:bg-purple-100 transition-colors">
                    <i class="fas fa-certificate text-purple-500"></i>
                  </div>
                  <div>
                    <h4 class="font-semibold text-gray-900">Certificate</h4>
                    <p class="text-xs text-gray-500">Completion certificate</p>
                  </div>
                </div>
                <div class="flex items-center text-sm text-purple-600 group-hover:text-purple-700">
                  Download certificate
                  <i class="fas fa-download ml-2 text-xs"></i>
                </div>
              </button>
            </div>
          </div>
        <% } %>
      </div>
    </div>
  </div>
</div>

<style>
  .line-clamp-2 {
    overflow: hidden;
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 2;
  }
</style>
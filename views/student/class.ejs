<!-- Navbar -->
<%-include('./partials/topnav') %>

<!-- Sidebar -->
<%-include('./partials/sidenav') %>

<!-- Main Content -->
<div class="container-fluid mt-4">
  <div class="row">
    <!-- Static Sidebar for desktop -->
    <div class="col-lg-3 d-none d-lg-block">
      <%-include('./partials/staticsidebar') %>
    </div>

    <!-- Main Dashboard Section -->
    <div class="col-lg-9">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <a href="/user/course/<%=courseId%>/<%=categoryId%>" class="btn btn-outline-primary btn-sm">
          <i class="fas fa-arrow-left me-1"></i> Back to Programs
        </a>
      </div>

      <main class="p-1">
        <%- include('../partials/messages') %>

        <!-- Videos Section -->
        <div class="mt-4">
          <% if (courseVideos && courseVideos.length > 0) { %>
            <div class="row">
              <!-- Main Video Section -->
              <div class="col-lg-9 col-md-12 mb-4">
                <div class="card border-0 shadow-sm">
                  <div class="card-body p-0">
                    <div class="video-container bg-dark rounded-top">
                      <video
                        id="mainVideo"
                        class="w-100"
                        style="height: 400px; object-fit: contain;"
                        controls
                        controlsList="nodownload"
                        poster="<%= courseVideos[0]?.thumbnail_url %>"
                        preload="metadata"
                      >
                        <source src="<%= courseVideos[0]?.video_url %>" type="video/mp4">
                        <source src="<%= courseVideos[0]?.video_url %>" type="video/webm">
                        <source src="<%= courseVideos[0]?.video_url %>" type="video/ogg">
                        Your browser does not support the video tag.
                        <track kind="captions" src="#" srclang="en" label="English">
                      </video>
                    </div>
                    
                    <div class="p-4">
                      <h3 class="text-dark mb-2" id="currentVideoTitle"><%= courseVideos[0].title || 'Part 1' %></h3>
                      <div class="d-flex align-items-center text-muted mb-3">
                        <span class="badge bg-primary me-2">
                          <i class="fas fa-film me-1"></i>
                          Part <span id="currentPartNumber"><%= courseVideos[0].part_number %></span>
                        </span>
                        <span class="badge bg-secondary">
                          <i class="fas fa-clock me-1"></i>
                          <span id="videoDuration">--:--</span>
                        </span>
                      </div>
                      
                      <!-- Video Controls -->
                      <div class="d-flex gap-2 mb-3">
                        <button class="btn btn-outline-primary btn-sm" onclick="togglePlayPause()">
                          <i class="fas fa-play" id="playPauseIcon"></i>
                          <span id="playPauseText">Play</span>
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="toggleMute()">
                          <i class="fas fa-volume-up" id="volumeIcon"></i>
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="toggleFullscreen()">
                          <i class="fas fa-expand"></i> Fullscreen
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

            
              </div>

              <!-- Playlist Sidebar -->
              <div class="col-lg-3 col-md-12">
                <div class="card border-0 shadow-sm">
                  <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                      <i class="fas fa-list me-2"></i>Video Playlist
                    </h5>
                  </div>
                  <div class="card-body">
                    <div class="playlist-container" style="max-height: 600px; overflow-y: auto;">
                      <% courseVideos.forEach((video, index) => { %>
                        <div class="video-playlist-item <%= index === 0 ? 'active' : '' %> mb-3 p-3 rounded border cursor-pointer"
                             onclick="loadVideo('<%= video.video_url %>', '<%= video.thumbnail_url %>', '<%= video.title %>', <%= video.part_number %>, this)">
                          <div class="d-flex align-items-center">
                            <div class="position-relative me-3">
                              <img src="<%= video.thumbnail_url %>" alt="Thumbnail" class="rounded" style="width: 80px; height: 60px; object-fit: cover;">
                              <div class="position-absolute top-0 start-0 bg-primary text-white px-1 rounded-end">
                                <small><%= video.part_number %></small>
                              </div>
                              <div class="position-absolute bottom-0 end-0 bg-dark bg-opacity-75 text-white px-1 rounded-start">
                                <small>--:--</small>
                              </div>
                            </div>
                            <div class="flex-grow-1">
                              <h6 class="mb-1 text-truncate" style="max-width: 180px;">
                                <%= video.title || `Part ${video.part_number}` %>
                              </h6>
                              <small class="text-muted">Part <%= video.part_number %></small>
                            </div>
                          </div>
                        </div>
                      <% }) %>
                    </div>
                  </div>
                </div>
              </div>
            </div>

          <% } else { %>
            <!-- No videos fallback -->
            <div class="card border-0 shadow-sm text-center py-5">
              <div class="card-body">
                <i class="fas fa-video-slash fa-4x text-muted mb-4"></i>
                <h3 class="text-muted">No Videos Available</h3>
                <p class="text-muted mb-4">The course videos haven't been uploaded yet. Please check back later.</p>
                <div class="d-flex justify-content-center gap-2">
                  <a href="/user/course/<%=courseId%>/<%=categoryId%>" class="btn btn-primary">
                    <i class="fas fa-arrow-left me-2"></i> Back to Events
                  </a>
                  <button class="btn btn-outline-secondary" onclick="location.reload()">
                    <i class="fas fa-redo me-2"></i>Refresh
                  </button>
                </div>
              </div>
            </div>
          <% } %>
        </div>
      </main>
    </div>
  </div>
</div>

<style>
.video-container {
  border-radius: 12px;
  overflow: hidden;
  background: #000;
}

.video-playlist-item {
  transition: all 0.3s ease;
  border: 2px solid transparent;
}

.video-playlist-item:hover {
  border-color: #4361ee;
  transform: translateX(5px);
}

.video-playlist-item.active {
  border-color: #4361ee;
  background: rgba(67, 97, 238, 0.05);
}

.cursor-pointer {
  cursor: pointer;
}

.playlist-container::-webkit-scrollbar {
  width: 6px;
}

.playlist-container::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 3px;
}

.playlist-container::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 3px;
}

.playlist-container::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}

.nav-tabs .nav-link {
  border: none;
  color: #6c757d;
  font-weight: 500;
  padding: 0.75rem 1.5rem;
}

.nav-tabs .nav-link.active {
  color: #4361ee;
  border-bottom: 3px solid #4361ee;
  background: transparent;
}

.list-group-item {
  border: none;
  padding: 0.75rem 1rem;
  margin-bottom: 0.5rem;
  border-radius: 8px !important;
}

.list-group-item:hover {
  background: #f8f9fa;
}
</style>

<script>
// Video player functionality
let currentVideo = document.getElementById('mainVideo');
let isPlaying = false;

function loadVideo(url, poster, title, partNumber, element) {
  try {
    // Update video source
    currentVideo.src = url;
    currentVideo.poster = poster;
    
    // Update UI
    document.getElementById('currentVideoTitle').textContent = title;
    document.getElementById('currentPartNumber').textContent = partNumber;
    
    // Update active state in playlist
    document.querySelectorAll('.video-playlist-item').forEach(item => {
      item.classList.remove('active');
    });
    element.classList.add('active');
    
    // Load and play video
    currentVideo.load();
    
    // Attempt to play video
    const playPromise = currentVideo.play();
    
    if (playPromise !== undefined) {
      playPromise.then(() => {
        console.log('Video started playing successfully');
        updatePlayPauseButton(true);
      }).catch(error => {
        console.log('Video play was prevented:', error);
        updatePlayPauseButton(false);
        // Show play button to user
        showPlayButton();
      });
    }
    
  } catch (error) {
    console.error('Error loading video:', error);
    showError('Failed to load video. Please try again.');
  }
}

function togglePlayPause() {
  if (currentVideo.paused || currentVideo.ended) {
    currentVideo.play().then(() => {
      updatePlayPauseButton(true);
    }).catch(error => {
      console.error('Play failed:', error);
      showError('Cannot play video. Please check your connection.');
    });
  } else {
    currentVideo.pause();
    updatePlayPauseButton(false);
  }
}

function toggleMute() {
  currentVideo.muted = !currentVideo.muted;
  const volumeIcon = document.getElementById('volumeIcon');
  volumeIcon.className = currentVideo.muted ? 'fas fa-volume-mute' : 'fas fa-volume-up';
}

function toggleFullscreen() {
  if (!document.fullscreenElement) {
    currentVideo.requestFullscreen().catch(err => {
      console.error('Error attempting to enable fullscreen:', err);
    });
  } else {
    document.exitFullscreen();
  }
}

function updatePlayPauseButton(playing) {
  const icon = document.getElementById('playPauseIcon');
  const text = document.getElementById('playPauseText');
  
  if (playing) {
    icon.className = 'fas fa-pause';
    text.textContent = 'Pause';
  } else {
    icon.className = 'fas fa-play';
    text.textContent = 'Play';
  }
  
  isPlaying = playing;
}

function showPlayButton() {
  // Ensure play button is visible when video needs user interaction
  updatePlayPauseButton(false);
}

function showError(message) {
  // Simple error notification
  alert(message);
}

// Video event listeners
currentVideo.addEventListener('loadedmetadata', function() {
  // Update duration display when metadata is loaded
  const duration = formatTime(currentVideo.duration);
  document.getElementById('videoDuration').textContent = duration;
});

currentVideo.addEventListener('timeupdate', function() {
  // Update progress if you add a progress bar later
});

currentVideo.addEventListener('ended', function() {
  updatePlayPauseButton(false);
});

currentVideo.addEventListener('play', function() {
  updatePlayPauseButton(true);
});

currentVideo.addEventListener('pause', function() {
  updatePlayPauseButton(false);
});

// Utility function to format time
function formatTime(seconds) {
  if (isNaN(seconds)) return '--:--';
  
  const minutes = Math.floor(seconds / 60);
  const remainingSeconds = Math.floor(seconds % 60);
  return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
  // Space bar to play/pause
  if (e.code === 'Space' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
    e.preventDefault();
    togglePlayPause();
  }
  
  // 'M' key to mute/unmute
  if (e.code === 'KeyM' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
    e.preventDefault();
    toggleMute();
  }
  
  // 'F' key for fullscreen
  if (e.code === 'KeyF' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
    e.preventDefault();
    toggleFullscreen();
  }
});

// Initialize the first video
document.addEventListener('DOMContentLoaded', function() {
  // Auto-play the first video if available
  if (courseVideos && courseVideos.length > 0) {
    const firstVideo = courseVideos[0];
    const firstPlaylistItem = document.querySelector('.video-playlist-item');
    loadVideo(firstVideo.video_url, firstVideo.thumbnail_url, firstVideo.title, firstVideo.part_number, firstPlaylistItem);
  }
  
  // Add loading state to video
  currentVideo.addEventListener('waiting', function() {
    console.log('Video is buffering...');
  });
  
  currentVideo.addEventListener('canplay', function() {
    console.log('Video can start playing');
  });
});

// Handle video errors
currentVideo.addEventListener('error', function(e) {
  console.error('Video error:', e);
  const error = currentVideo.error;
  let message = 'An error occurred while loading the video.';
  
  switch (error.code) {
    case error.MEDIA_ERR_ABORTED:
      message = 'Video playback was aborted.';
      break;
    case error.MEDIA_ERR_NETWORK:
      message = 'A network error occurred. Please check your connection.';
      break;
    case error.MEDIA_ERR_DECODE:
      message = 'Video format is not supported.';
      break;
    case error.MEDIA_ERR_SRC_NOT_SUPPORTED:
      message = 'Video format is not supported by your browser.';
      break;
  }
  
  showError(message);
});
</script>